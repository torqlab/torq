import { describe, test, expect } from 'bun:test';

import getStravaActivitySignals from './get-strava-activity-signals';
import { StravaActivity, StravaActivitySignals } from './types';

type Case = [string, StravaActivity, StravaActivitySignals];

describe('get-activity-signals', () => {
  describe('it extracts signals from valid activity', () => {
    test.each<Case>([
      [
        'valid mountain bike ride with minimal fields',
        {
          id: 123456,
          type: 'Ride',
          sport_type: 'MountainBikeRide',
          distance: 28099,
          moving_time: 4207,
          total_elevation_gain: 516,
          start_date_local: '2018-02-16T06:52:54Z',
        },
        {
          core: {
            activityType: 'MountainBikeRide',
            intensity: 'high',
            elevation: 'mountainous',
            timeOfDay: 'morning',
            tags: undefined,
            brands: undefined,
            semanticContext: undefined,
          },
          derived: {
            mood: 'intense',
            style: 'illustrated',
            subject: 'athlete',
            terrain: 'mountainous terrain',
            environment: 'outdoor training space',
            atmosphere: 'soft morning light',
          },
        },
      ],
      [
        'valid running with minimal data',
        {
          id: 123456,
          type: 'Run',
          sport_type: 'Run',
          name: 'Morning Run',
          description: 'Nice run in the park',
          distance: 5000,
          moving_time: 1500,
          total_elevation_gain: 50,
          start_date_local: '2024-01-01T07:00:00Z',
          gear: { name: 'Nike Shoes' },
        },
        {
          core: {
            activityType: 'Run',
            intensity: 'medium',
            elevation: 'rolling',
            timeOfDay: 'morning',
            tags: undefined,
            brands: ['Nike Shoes'],
            semanticContext: ['morning', 'park'],
          },
          derived: {
            mood: 'focused',
            style: 'cartoon',
            subject: 'runner',
            terrain: 'rolling hills',
            environment: 'outdoor training space',
            atmosphere: 'soft morning light',
          },
        },
      ],
      [
        'valid running (17359450317)',
        {
          athlete: {
            id: 111872688,
          },
          name: 'Having a morning of aerobic conditioning. ðŸƒâ€â™‚ï¸ The spring is closeâ€¦ ðŸŒ¤ï¸',
          distance: 9528.7,
          moving_time: 3585,
          total_elevation_gain: 181,
          type: 'Run',
          sport_type: 'TrailRun',
          workout_type: 3,
          device_name: 'Garmin fÄ“nix 7',
          id: 17359450317,
          start_date: '2026-02-11T04:29:54Z',
          start_date_local: '2026-02-11T06:29:54Z',
          timezone: '(GMT+02:00) Europe/Kyiv',
          utc_offset: 7200,
          achievement_count: 0,
          comment_count: 0,
          athlete_count: 1,
          photo_count: 0,
          trainer: false,
          commute: false,
          start_latlng: [49.31, 23.52],
          end_latlng: [49.31, 23.52],
          average_speed: 2.658,
          max_speed: 3.06,
          average_cadence: 83.8,
          average_watts: 252,
          max_watts: 392,
          weighted_average_watts: 255,
          device_watts: true,
          kilojoules: 903.7,
          elev_high: 390.6,
          elev_low: 329.2,
          pr_count: 0,
          total_photo_count: 1,
          description:
            'ðŸ¤– Adding an image generated by my AI service PACE. Still not ideal, many things must be improved. Anyway, Iâ€™m pleased with the progress!',
          calories: 741,
          gear: {
            id: 'g14554890',
            name: 'HOKA Speedgoat 5 Hoka Speedgoat 5',
            nickname: 'Hoka Speedgoat 5',
          },
        },
        {
          core: {
            activityType: 'TrailRun',
            intensity: 'low',
            elevation: 'rolling',
            timeOfDay: 'morning',
            tags: undefined,
            brands: ['HOKA Speedgoat 5 Hoka Speedgoat 5 Hoka Speedgoat 5'],
            semanticContext: ['morning', 'spring'],
          },
          derived: {
            mood: 'calm',
            style: 'cartoon',
            subject: 'trail runner',
            terrain: 'rolling hills',
            environment: 'outdoor training space',
            atmosphere: 'soft morning light',
          },
        },
      ],
      [
        'valid yoga (17348009150)',
        {
          athlete: {
            id: 111872688,
          },
          name: 'Calming down after a stressful dayâ€¦ ðŸ§˜â€â™‚ï¸ Preparing my mind and body for sleep. ðŸ˜´',
          distance: 0,
          moving_time: 1803,
          total_elevation_gain: 0,
          type: 'Yoga',
          sport_type: 'Yoga',
          workout_type: 31,
          device_name: 'Garmin fÄ“nix 7',
          id: 17348009150,
          start_date: '2026-02-09T19:22:13Z',
          start_date_local: '2026-02-09T21:22:13Z',
          timezone: '(GMT+02:00) Africa/Blantyre',
          utc_offset: 7200,
          achievement_count: 0,
          comment_count: 0,
          athlete_count: 1,
          commute: false,
          start_latlng: [],
          end_latlng: [],
          average_speed: 0,
          max_speed: 0,
          elev_high: 0,
          elev_low: 0,
          pr_count: 0,
          total_photo_count: 1,
          description: '',
          calories: 80,
        },
        {
          core: {
            activityType: 'Yoga',
            intensity: 'medium',
            elevation: 'flat',
            timeOfDay: 'night',
            tags: undefined,
            brands: undefined,
            semanticContext: undefined,
          },
          derived: {
            mood: 'focused',
            style: 'cartoon',
            subject: 'athlete',
            terrain: 'flat terrain',
            environment: 'outdoor training space',
            atmosphere: 'dark night atmosphere',
          },
        },
      ],
      [
        'valid weight training (17303325722)',
        {
          athlete: {
            id: 111872688,
          },
          name: 'Sadly skipping the running session due to extra slippery roads. ðŸ˜• Falling back the the kettlebells wright training. ðŸ‹ï¸ Trying to avoid accidents and save my body for the events season. ðŸƒâ€âž¡ï¸',
          distance: 0,
          moving_time: 2387,
          total_elevation_gain: 0,
          type: 'WeightTraining',
          sport_type: 'WeightTraining',
          workout_type: 30,
          device_name: 'Garmin fÄ“nix 7',
          id: 17303325722,
          start_date: '2026-02-05T19:17:54Z',
          start_date_local: '2026-02-05T21:17:54Z',
          timezone: '(GMT+02:00) Africa/Blantyre',
          utc_offset: 7200,
          achievement_count: 0,
          comment_count: 0,
          athlete_count: 1,
          photo_count: 0,
          trainer: true,
          commute: false,
          start_latlng: [],
          end_latlng: [],
          average_speed: 0,
          max_speed: 0,
          elev_high: 0,
          elev_low: 0,
          pr_count: 0,
          total_photo_count: 1,
          description:
            "As usual, listening to the learning materials. I'm a constant student, as I desire to stay the best in my field.",
          calories: 269,
        },
        {
          core: {
            activityType: 'WeightTraining',
            intensity: 'medium',
            elevation: 'flat',
            timeOfDay: 'night',
            tags: undefined,
            brands: undefined,
            semanticContext: ['road', 'fall', 'kettlebells'],
          },
          derived: {
            mood: 'focused',
            style: 'cartoon',
            subject: 'athlete',
            terrain: 'flat terrain',
            environment: 'outdoor training space',
            atmosphere: 'dark night atmosphere',
          },
        },
      ],
      [
        'valid walk (16861704067)',
        {
          athlete: {
            id: 111872688,
          },
          name: 'Walking with a toddler during the snowstorm. â˜ƒï¸  Just happy to have a snow around. ðŸ‘',
          distance: 2156,
          moving_time: 2808,
          total_elevation_gain: 62,
          type: 'Walk',
          sport_type: 'Walk',
          device_name: 'Garmin fÄ“nix 7',
          id: 16861704067,
          start_date: '2025-12-28T09:03:37Z',
          start_date_local: '2025-12-28T11:03:37Z',
          timezone: '(GMT+02:00) Europe/Kyiv',
          utc_offset: 7200,
          achievement_count: 0,
          comment_count: 0,
          athlete_count: 1,
          photo_count: 0,
          trainer: false,
          commute: false,
          start_latlng: [49.31, 23.52],
          end_latlng: [49.31, 23.52],
          average_speed: 0.768,
          max_speed: 1.3,
          average_cadence: 56,
          elev_high: 346.4,
          elev_low: 309.4,
          pr_count: 0,
          total_photo_count: 1,
          description: '',
          calories: 191,
          perceived_exertion: 1,
        },
        {
          core: {
            activityType: 'Walk',
            intensity: 'low',
            elevation: 'rolling',
            timeOfDay: 'day',
            tags: undefined,
            brands: undefined,
            semanticContext: undefined,
          },
          derived: {
            mood: 'calm',
            style: 'cartoon',
            subject: 'walker',
            terrain: 'rolling hills',
            environment: 'outdoor training space',
            atmosphere: 'bright daylight',
          },
        },
      ],
    ])('%#. %s', (_name, activity, expected) => {
      const signals = getStravaActivitySignals(activity, (input) => input.includes('forbidden'));

      expect(signals).toStrictEqual(expected);
    });
  });

  describe('it throws error for invalid activity', () => {
    test('throws error for invalid activity', () => {
      const activity: StravaActivity = {
        id: 123456,
        // Missing required fields...
      } as StravaActivity;

      expect(() =>
        getStravaActivitySignals(activity, (input) => input.includes('forbidden')),
      ).toThrow();
    });
  });
});
