name: Specification Validation

on:
  pull_request:
    paths:
      - "specs/**/*.spec.md"
      - "tools/validate-specifications/**"
  push:
    branches:
      - main
    paths:
      - "specs/**/*.spec.md"
      - "tools/validate-specifications/**"

jobs:
  validate-specifications:
    name: Validate Specifications
    runs-on: self-hosted

    permissions:
      contents: read

    env:
      DIAL_KEY: ${{ secrets.DIAL_KEY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js 24
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Install bash utilities
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y jq
          fi

      - name: Run specification validation
        run: |
          touch .specification-validation/result.json
          node tools/validate-specifications/index.js > .specification-validation/result.json

      - name: Parse validation result
        id: validation
        run: |
          RESULT=$(jq -r '.result' .specification-validation/result.json)
          INVALID_COUNT=$(jq '[.violations[] | select(.severity=="INVALID")] | length' .specification-validation/result.json)
          CONDITIONAL_COUNT=$(jq '[.violations[] | select(.severity=="CONDITIONAL")] | length' .specification-validation/result.json)

          echo "result=$RESULT" >> "$GITHUB_OUTPUT"
          echo "invalid_count=$INVALID_COUNT" >> "$GITHUB_OUTPUT"
          echo "conditional_count=$CONDITIONAL_COUNT" >> "$GITHUB_OUTPUT"

      - name: Render validation summary
        if: always()
        run: |
          {
            echo "# üìã Specification Validation Result"
            echo ""
            echo "| Metric | Value |"
            echo "|-------|-------|"
            echo "| Result | **${{ steps.validation.outputs.result }}** |"
            echo "| Invalid violations | ${{ steps.validation.outputs.invalid_count }} |"
            echo "| Conditional violations | ${{ steps.validation.outputs.conditional_count }} |"
            echo ""
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Render validation violations
        if: always()
        run: |
          echo "## ‚ùå Violations" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Spec | Rule | Severity | Description |" >> "$GITHUB_STEP_SUMMARY"
          echo "|------|------|----------|-------------|" >> "$GITHUB_STEP_SUMMARY"

          jq -r '.violations[] |
          "| \(.spec_id // "global") | \(.rule) | **\(.severity)** | \(.description) |"
          ' .specification-validation/result.json >> "$GITHUB_STEP_SUMMARY"

      - name: Fail pipeline on failed validation
        if: steps.validation.outputs.result == 'INVALID'
        run: |
          echo "‚ùå Specification validation failed!"
          exit 1
