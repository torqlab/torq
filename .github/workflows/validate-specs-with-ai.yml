name: Validate Specs with AI

on:
  push:
    branches: [main]
    paths:
      - "openspec/**"
      - "packages/validate-specs/validate-specs-with-ai"
      - ".github/workflows/validate-specs-with-ai.yml"
  workflow_dispatch:

jobs:
  validate-specs-with-ai:
    name: Validate Specs with AI
    runs-on: self-hosted

    outputs:
      validation-status: ${{ steps.validation.outputs.result }}
      validation-summary-json: ${{ steps.expose-validation-summary-json.outputs.validation_summary_json }}

    permissions:
      contents: read

    env:
      DIAL_KEY: ${{ secrets.DIAL_KEY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Fetch full history to ensure we can compare with any previous commit

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Setup bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Ensure jq is available
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y jq
          fi

      - name: Install dependencies
        run: bun install

      - name: Log basic validation prompts (w/o injected specs)
        run: |
          echo "=== System prompt ==="
          cat prompts/validate-specs.system.md
          echo ""
          echo "=== User prompt ==="
          cat prompts/validate-specs.user.md

      - name: Detect changed spec files
        id: changed-specs
        run: |
          # Get the base commit for comparison
          # For push events, use github.event.before if available, otherwise HEAD~1
          if [ -n "${{ github.event.before }}" ] && [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
            BASE_SHA="${{ github.event.before }}"
          else
            # Fallback: try HEAD~1, or use HEAD if it's the first commit
            BASE_SHA=$(git rev-parse HEAD~1 2>/dev/null || echo "HEAD")
          fi
          
          # Get changed files and filter for .spec.md files *within openspec*
          CHANGED_SPECS=$(git diff --name-only --diff-filter=ACMRT "$BASE_SHA" HEAD 2>/dev/null | grep '^openspec/.*spec\.md$' || true)
          
          if [ -n "$CHANGED_SPECS" ]; then
            # Convert newlines to commas and make paths absolute
            SPEC_PATHS=$(echo "$CHANGED_SPECS" | while read -r file; do
              echo "$(pwd)/$file"
            done | tr '\n' ',' | sed 's/,$//')
            echo "spec_paths=$SPEC_PATHS" >> "$GITHUB_OUTPUT"
            echo "has_changed_specs=true" >> "$GITHUB_OUTPUT"
            echo "Found changed spec files:"
            echo "$CHANGED_SPECS"
          else
            echo "has_changed_specs=false" >> "$GITHUB_OUTPUT"
            echo "No changed spec files found"
          fi

      - name: Run specs validation
        run: |
          mkdir -p .specs-validation/ai
          
          if [ "${{ steps.changed-specs.outputs.has_changed_specs }}" = "true" ]; then
            echo "Validating only changed spec files..."
            bun run --filter @pace/validate-specs validate-specs:ai -- --specFilePaths "${{ steps.changed-specs.outputs.spec_paths }}" --systemPrompt $(pwd)/prompts/validate-specs.system.md --userPrompt $(pwd)/prompts/validate-specs.user.md > .specs-validation/ai/raw-output.txt 2>&1 || {
              echo "Validation script failed. Raw output:"
              cat .specs-validation/ai/raw-output.txt
              # Create a valid error JSON response
              echo '{"result": "INVALID", "violations": [], "notes": ["Validation script execution failed"]}' > .specs-validation/ai/result.json
            }
          else
            echo "No changed spec files detected, validating all specs..."
            bun run --filter @pace/validate-specs validate-specs:ai -- --rootDir $(pwd) --systemPrompt $(pwd)/prompts/validate-specs.system.md --userPrompt $(pwd)/prompts/validate-specs.user.md > .specs-validation/ai/raw-output.txt 2>&1 || {
              echo "Validation script failed. Raw output:"
              cat .specs-validation/ai/raw-output.txt
              # Create a valid error JSON response
              echo '{"result": "INVALID", "violations": [], "notes": ["Validation script execution failed"]}' > .specs-validation/ai/result.json
            }
          fi
          
          # Sanitize the raw output: strip Bun prefix and remove "Exited with code" line
          # Only do this if result.json doesn't exist (command succeeded)
          if [ ! -f .specs-validation/ai/result.json ] && [ -f .specs-validation/ai/raw-output.txt ]; then
            # Show raw output for debugging
            echo "Raw validator output:"
            cat .specs-validation/ai/raw-output.txt
            echo ""
            
            # Strip the Bun prefix and filter out non-JSON lines
            sed 's/^@pace\/validate-specs validate-specs:ai: //' .specs-validation/ai/raw-output.txt | \
              grep -v '^Exited with code' | \
              grep -v '^$' > .specs-validation/ai/result.json || {
              echo "Failed to sanitize output. Creating error response."
              echo '{"result": "INVALID", "violations": [], "notes": ["Failed to parse validation output"]}' > .specs-validation/ai/result.json
            }
          fi
          
          # Validate that the output is valid JSON
          if ! jq empty .specs-validation/ai/result.json 2>/dev/null; then
            echo "Error: result.json is not valid JSON after sanitization. Content:"
            cat .specs-validation/ai/result.json
            echo '{"result": "INVALID", "violations": [], "notes": ["Invalid JSON output from validation script"]}' > .specs-validation/ai/result.json
          fi

      - name: Expose validation result JSON (as base64)
        id: expose-validation-summary-json
        run: |
          SUMMARY_B64=$(base64 < .specs-validation/ai/result.json | tr -d '\n')
          echo "validation_summary_json=$SUMMARY_B64" >> "$GITHUB_OUTPUT"

      - name: Parse validation result
        id: validation
        run: |
          RESULT=$(jq -r '.result // "INVALID"' .specs-validation/ai/result.json)
          VIOLATION_COUNT=$(jq '[.violations[]?] | length' .specs-validation/ai/result.json)
          NOTES_COUNT=$(jq '[.notes[]?] | length' .specs-validation/ai/result.json)

          echo "result=$RESULT" >> "$GITHUB_OUTPUT"
          echo "violation_count=$VIOLATION_COUNT" >> "$GITHUB_OUTPUT"
          echo "notes_count=$NOTES_COUNT" >> "$GITHUB_OUTPUT"

      - name: Check for execution errors
        if: steps.validation.outputs.notes_count != '0'
        run: |
          echo "‚ö†Ô∏è Validation script encountered errors:"
          jq -r '.notes[]?' .specs-validation/ai/result.json | while read -r note; do
            echo "  - $note"
          done
          echo ""
          echo "This indicates the validation script failed to execute properly."
          echo "Please check the logs above for details."

      - name: Render validation summary
        if: always()
        run: |
          {
            echo "# üìã Specs Validation Result"
            echo ""
            echo "| Metric | Value |"
            echo "|-------|-------|"
            echo "| Result | **${{ steps.validation.outputs.result }}** |"
            echo "| Violations | ${{ steps.validation.outputs.violation_count }} |"
            if [ "${{ steps.validation.outputs.notes_count }}" != "0" ]; then
              echo "| Notes | ${{ steps.validation.outputs.notes_count }} |"
            fi
            echo ""
          } >> "$GITHUB_STEP_SUMMARY"
          
          # Render notes if they exist
          if [ "${{ steps.validation.outputs.notes_count }}" != "0" ]; then
            {
              echo "## ‚ö†Ô∏è Validation Notes" >> "$GITHUB_STEP_SUMMARY"
              echo "" >> "$GITHUB_STEP_SUMMARY"
              jq -r '.notes[]?' .specs-validation/ai/result.json | while read -r note; do
                echo "- $note" >> "$GITHUB_STEP_SUMMARY"
              done
              echo "" >> "$GITHUB_STEP_SUMMARY"
            }
          fi

      - name: Render validation violations
        if: steps.validation.outputs.result != 'VALID'
        run: |
          echo "## ‚ùå Violations" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Spec ID | Rule | Description |" >> "$GITHUB_STEP_SUMMARY"
          echo "|------|------|-------------|" >> "$GITHUB_STEP_SUMMARY"

          jq -r '.violations[]? as $violation |
            ($violation.spec_id // "global") as $id |
            ($id | if test("^/") then sub("^.*/openspec/"; "openspec/") else . end) as $display |
            "| \($display) | \($violation.rule // "unknown") | \($violation.description // "No description") |"
          ' .specs-validation/ai/result.json >> "$GITHUB_STEP_SUMMARY"

  fix-specs-with-ai-approval:
    name: Fix Specs with AI Approval
    needs: validate-specs-with-ai
    if: always() && needs.validate-specs-with-ai.outputs.validation-status == 'INVALID'
    runs-on: ubuntu-latest
    environment:
      name: fix-specs-with-ai-approval
    steps:
      - name: Approval granted
        run: echo "Approval granted for fixing AI validation issues with AI"

  fix-specs-with-ai:
    name: Fix Specs with AI
    needs: [validate-specs-with-ai, fix-specs-with-ai-approval]
    if: always() && needs.validate-specs-with-ai.outputs.validation-status == 'INVALID' && needs.fix-specs-with-ai-approval.result == 'success'
    uses: ./.github/workflows/fix-specs-with-ai.yml
    secrets: inherit
    permissions:
      contents: write
      pull-requests: write
    with:
      summary: ${{ needs.validate-specs-with-ai.outputs.validation-summary-json }}

  finally:
    name: Finalize AI-Driven Specs Validation
    needs: [validate-specs-with-ai, fix-specs-with-ai]
    runs-on: self-hosted

    steps:
      - name: Fail pipeline on failed validation
        if: needs.validate-specs-with-ai.outputs.validation-status == 'INVALID'
        run: |
          echo "‚ùå Specs validation failed! Please review the validation summary above and address the issues."
          echo "ü§ñ Or rely on the agent which already tries to fix the issues."
          exit 1
